## 数据库优化方案

### 读写分离

#### 技术关键点

  - 数据拷贝（主从复制）
  - 在主从分离情况下如何屏蔽主从分离带来的访问数据库方式的变化

#### 主从复制的过程

  首先从库在连接到主节点时会创建一个 IO 线程，用以请求主库更新的 binlog，并且把接收到的 binlog 信息写入一个叫做 relay log 的日志文件中，而主库也会创建一个 log dump 线程来发送 binlog 给从库；同时，从库还会创建一个 SQL 线程读取 relay log 中的内容，并且在从库中做回放，最终实现主从的一致性

  使用独立的 log dump 线程是异步方式，避免对主库的主体更新流程产生影响。从苦接收到信息后先写入 relay log，避免写入从库的市局存储比较耗时，造成主从延迟

随着从库数量增加，从库连接上来的 IO 线程比较多，主库也需要创建同样多的 log dump 线程来处理复制的请求，对于主库资源消耗比较高，同时受限于主库的网络带宽，所以在实际使用中，一般一个主库最多挂 3～5 个从库

#### 主从延迟解决方案

  - 数据的冗余。在发送消息队列时不仅仅发送 ID，而是发送队列处理机需要的所有信息，借此避免从数据库中重新查询数据
  - 缓存：更新数据时会有缓存和数据库数据不一致的情况
  - 查询主库：主库压力过大

#### 主从的一致性和写入性能的权衡

  如果要保证所有从节点都写入成功，那么写入性能一定会受影响；

  如果只写入主节点就返回成功，那么从节点就有可能出现数据同步失败的情况，从而造成主从不一致，而在互联网的项目中，一般会优先考虑性能而不是数据的强一致性

### 分库分表

依照某一种策略将数据尽量平均的分配到多个数据库节点或者多个表中

分库分表后，每个节点只保存部分的数据，这样可以有效地减少单个数据库节点和单个数据表中存储的数据量，提高并发写入性能

#### 垂直拆分

将数据库的表拆分到多个不同的数据库中，一般根据业务类型拆分，专库专用，将业务耦合度高的表拆分到独立的库中

数据库垂直拆分后依然不能解决某一个业务模块的数据大量膨胀的问题

#### 水平拆分

将单一数据表按照某一种规则拆分到多个数据库和多个数据表中

拆分规则
  - 哈希值拆分
  - 区间拆分

#### 分库分表的问题

使用 ID 做分区间，但是需要按昵称查询的时候就要向所以的库和表发送查询请求，性能差

跨库查询复杂度高

#### 分库分表原则

1. 如果在性能上没有瓶颈点那么就尽量不做分库分表
1. 如果要做，就尽量一次到位，比如说 16 库 64 表就基本能够满足为了几年内你的业务的需求
1. 很多的 NoSQL 数据库，例如 Hbase，MongoDB 都提供 auto sharding 的特性，如果团队内部对于这些组件比较熟悉，有较强的运维能力，那么也可以考虑使用这些 NoSQL 数据库替代传统的关系型数据库
