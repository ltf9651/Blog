## PHP性能优化

* PHP代码的运行流程

```
php文件->zend引擎逐行扫描->php文件转码解析成zend引擎能识别的语法->解析成Opcodes(最终拿去执行机器代码) ->执行->输出
PHP缓存多使用opcode缓存，可以减少编译解析，提高效率加快速度
php内置函数会节省扫描转码的时间，生成的opcode体积也会小，执行也快，所以内置函数是比自己写的代码运行的速度要快的
```

* 语言特性
  * PHP不适合密集型运算的场景（大批量的日志分析、大批量数据处理、处理大数据），应减少计算密集型业务
  * PHP的底层是C，PHP的运算、处理流程都需要转换成C来实现，加上PHP的运行环境等因素，其效率不如C
  * PHP擅长场景： 衔接Webserver与后端服务UI呈现

* 内存
  * PHP有内存回收机制，使用unset()可及时释放不使用的内存，提高程序性能。
  * PHP限制每个脚本的内存使用量
  * 尽量少用正则表达式（回溯开销较大），使用字符串函数实现相同效果

* **缓存**：重复、多次请求的内容，"一劳永逸"，启用**OPcode cache**（缓存编译、节约执行开销，[缓存工具](http://pecl.php.net/packages.php)）


* 禁止使用错误抑制符（开销大）

* 使用 `try catch`来捕获错误

* 避免在循环内做运算
```php
for($i=0;$i<strlen($str);$i++){} // wrong，strlen($str)被重复调用

$strlen = strlen($str);
for($i=0;$i<$strlen;$i++){} // right
```

* 数组的键值要用引号，而且尽量使用单引号，否则php会把键值当作常量处理，就会增加查找常量方面的开销且程序可能报错（单引号中的内容不被解析，而双引号中的内容会被解析，因此，在这里使用单引号是一个很好的习惯）

* 常见php场景的开销次序：`读写内存 << 读写数据库 < 读写磁盘 < 读写网络数据(socket)`

* 尽量减少文件类操作：减少与磁盘的交互，规避从磁盘读写大文件或者读写很大的网络接口

* 优化网络请求
  * 设置超时时间
    * 连接超时 200ms
    * 读超时 800ms
    * 写超时 500ms
  * 将串行请求并行化
    * **Swoole**
    * 使用curl_multi_*()

* 接口输出优化-压缩(gzip)
  * 接口数据小于100k不建议使用压缩
  * 数据重复内容多压缩效果越明显，重复越少效果越不明显
  * 压缩利弊
    * 利:有利于数据输出，client端能更好获取数据
    * 弊:额外开销(压缩、解压)

* 性能分析工具
  * AB
  * Jmeter
  * XHProf
  * vld-opcode

* 突破性能瓶颈
  * Opcode Cache缓存
  * 通过PHP扩展代替原有PHP中的高频业务逻辑（扩展基于C语言，编译快）
  * Runtime优化：HHVM（目前ZendEngine官说已与HHVM相差不大）
  * JIT

- Session
  1. PHP的Session存储形式：files, 存储路径: /tmp/
  1. 如果集群轮询会导致用户可能访问到不同服务器，Session文件不同步
  1. 将Session存入Redis，Redis部署在一台所有机器可访问的服务器中（Redis本质上是数据库，可通过ip, port 访问，可配置主从···)

- **高并发**
  - 解决方案
    - 数据库缓存，负载均衡
    - CDN | QPS（单位时间处理请求量） > 800
    - Memcache，静态HTML缓存| QPS > 1000
    - 业务分离，分布式存储 | QPS > 2000
  - 优化
    - 前端优化
      - 防盗链处理（去除恶意请求、外站对本站的资源占用）
        - 通过检测Header头的Referer或者签名检测来源，若不是本站则不让其加载 :配置`ngx_http_referer_module`、`valid_referers`
        - `配置accesskey`
      - 减少HTTP请求（合并CSS、JS、图片）
      - 添加异步请求（需要时再加载）
      - 启用浏览器缓存和文件压缩
      - CDN加速（前端资源放入CDN）
      - 建立独立的图片服务器
    - 服务端优化
      - HTML页面静态化(QPS: PHP > HTML)
      - 并发处理（Swoole，Kafka）
    - 数据库优化
      - 数据库缓存（Memcache，Redis）
      - 分区、分库分表
      - 读写分离
      - 负载均衡
    - Web服务器优化
      - 负载均衡（反向代理、LVS）