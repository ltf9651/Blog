## 流媒体协议

视频就是快速播放一连串连续的图片，一张图片为一帧

视频数据量巨大，使用编码进行压缩

视频编码
  - VCEG
  - MPEG

网络将编码好的视频流从主播端推送到服务器，服务器上接流后对视频流做转码等处理，流处理完毕后等待观众的客户端请求视频流（拉流），拉流后观众客户端进行解码，将一串串二进制转换成一帧帧图片进行播放

如果有非常多的观众，同时看一个视频直播，那都从一个服务器上拉流，压力太大了，因而需要一个视频的分发网络，将视频预先加载到就近的边缘节点，这样大部分观众看的视频，是从边缘节点拉取的，就能降低服务器的压力

### 编码

视频序列的三种帧
  - I 帧，关键帧，里面是完整的图片，只需要本帧数据就可以完成解码
  - P 帧，前向预测编码帧，标识这一帧与之前的一个 I 帧或 P 帧的差别，解码时需要用之前缓存的画面，叠加上和本帧定义的差别，生成最终画面
  - B 帧，双向预测编码帧，记录的是本帧与前后帧的差别。要解码 B 帧，要取得之前的缓存画面和解码后的画面，通过前后画面的数据与本帧数据的叠加取得最终画面

I 帧最完整，B 帧压缩率最高

一个视频，可以拆分成一系列的帧，每一帧拆分成一系列的片，每一片都放在一个 NALU（网络提取层单元 Network Abstracton Layer Unit） 里面，NALU 之间都是通过特殊的起始标识符分隔，在每一个 I 帧的第一片前面，要插入单独保存 SPS 和 PPS 的 NALU，最终形成一个长长的 NALU 序列

压缩好的数据，为了传输组成一系列 NALU，按照帧和片依次排列

### 数据流推送

使用 RTMP 协议将二进制的流打包成网络包进行发送

RTMP 协议基于 TCP 协议，需要双方建立 TCP 连接，在此 TCP 连接的基础上再建立一个 RTMP 连接
  - RTMP 连接保证传输正常进行
  - 检测版本号
  - 带上时间戳

1. 客户端发送 C0 表示自己的版本号，C1 表示自己的时间戳

1. 服务端收到 C0 的时候返回 S0，表明自己的版本号，不匹配就断开连接

1. 服务器发送完 S0 后发送自己的时间戳 S1，客户端收到 S1 后发送 ACK C2，同理服务器收到发送 ACK S2

1. 握手完成

推流的过程，就是将 NALU 放在 Message 里面发送，这个也称为 RTMP Packet 包

排列好的 NALU，在网络传输的时候，要按照 RTMP 包的格式进行包装，RTMP 的包会拆分成 Chunk 进行传输

推送到流媒体集群的视频流经过转码和分发，可以被客户端通过 RTMP 协议拉取，然后组合为 NALU，解码成视频格式进行播放
