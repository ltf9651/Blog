## 08 | 准备Plan B：如何设计兜底方案?

- 高可用建设
  ![ ](https://static001.geekbang.org/resource/image/42/35/4225335357b6208a67410c36ea8a1535.jpg)
  - 架构阶段
    - 可扩展性
    - 容错性
    - 避免系统出现单点问题（多机房单元化部署，避免某个城市的机房出现问题导致整体故障）
  - 编码阶段
    - 代码健壮性：设置合理的超时退出机制，防止被其他系统拖垮，对调用的返回结果有预期，防止返回结果超出程序处理范围（使用错误异常捕获，对无法预料的错误有默认处理）
  - 测试阶段
    - 保证测试用例的覆盖度，保证最坏情况发生时仍有相应处理流程
  - 发布阶段
    - 紧急回滚机制
  - 运行阶段
    - 对系统监控准确、及时，发现问题能够准确报警且报警数据详细，便于排查问题
  - 故障发生
    - 及时止损
    - 及时下架商品或关闭购买链接
    - 能够及时恢复服务，并定位原因，解决问题

- 运行阶段处理
  - 降级：当系统容量达到一定程度时，限制或者关闭系统某些非核心功能
    ![ ](https://static001.geekbang.org/resource/image/13/1a/1310c57927f5b0ef1b3e8f6bef8f2e1a.jpg)
    - 方案：当流量达到高峰时，把成交记录的获取从50条降级到只展示5条，“50到5”由一个开关控制，设置一个能够从开关系统动态获取的系统参数
    - 目标：牺牲一部分用户体验保障和提升系统性能和业务数据准确性
  - 限流：当系统达到瓶颈，通过限制一部分流量来保护系统
    ![ ](https://static001.geekbang.org/resource/image/79/5a/796b93a97ae4083412ff352148a8bc5a.jpg)
    - 客户端限流
      - 可以限制请求的发出，通过减少发出无用请求从而减少对系统的消耗
      - 当客户端比较分散时没法合理的设置限流阈值
      - 阈值设计不当会导致服务端性能浪费或起不到限制作用
    - 服务端限流
      - 可以根据服务端性能合理设置阈值
      - 被限制的请求都是无效请求，处理这些无效请求本身也会消耗服务器资源
    - 限流会导致一部分用户请求失败，所以在处理这些异常时要设置超时时间，防止被限流的请求因不能迅速被处理而拖垮系统
  - 拒绝服务：当系统负载达到一定阈值时拒绝所有请求，应付最坏情况
    - 在最前端的Nginx上设置过载保护，当机器负载到某个值时直接拒绝HTTP请求并返回503错误码


网站的高可用建设是基础，可以说要深入到各个环节，更要长期规划并进行体系化建设，要在预防（建立常态的压力体系，例如上线后的全链路压测）、管控（做好线上运行时的降级、限流和兜底保护）、监控（建立性能基线来记录性能的变化趋势以及线上机器的负载报警体系，发现问题及时预警）和恢复体系（遇到故障要及时止损，并提供快速的数据订正工具等）等这些地方加强建设，每一个环节可能都有很多事情要做。

另外，要保证高可用建设的落实，你不仅要做系统建设，还要在组织上做好保障。高可用其实就是在说“稳定性”。稳定性是一个平时不重要，但真出了问题就会要命的事儿，所以很可能平时业务发展良好，稳定性建设就会给业务让路，相关的稳定性负责人员平时根本得不到重视，一旦遇到故障却又成了“背锅侠”。

而要防止出现这种情况，就必须在组织上有所保障，例如可以让业务负责人背上稳定性 KPI考核指标，然后在技术部门中建立稳定性建设小组，小组成员由每个业务线的核心力量兼任，他们的 KPI 由稳定性负责人来打分，这样稳定性小组就可以把一些体系化的建设任务落实到具体的业务系统中了。