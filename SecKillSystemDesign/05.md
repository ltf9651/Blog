## 05 | 流量削峰这事应该怎么做？

**削峰的存在，一是可以让服务端处理变得更加平稳，二是可以节省服务器资源。削峰从本质上来说就是更多地延缓用户请求的发出，以便减少和过滤掉一些无效请求，遵从“请求数要尽量少”的原则**

1. 排队
  ![ ](https://static001.geekbang.org/resource/image/db/d9/db0e4dcd2c66bc5611c4d6adccbb0bd9.jpg)
  - 消息队列缓冲瞬间流量：把同步的调用转换成异步的间接推送，中间通过一个队列在一端承接瞬时的流量洪峰，在另一端平滑地将消息推送出去。
    - 若流量峰值持续一段时间达到消息队列的处理上限，消息队列会被压垮，这样即使保护了下游的推送，但是上游的请求会直接被丢弃。
  - 利用线程池锁等待
  - 先进先出、先进后出等常用内存排队算法实现方式
  - 把请求序列化到文件中，再顺序的读文件来恢复请求

2. 答题（适用于秒杀或者营销活动）
  ![ ](https://static001.geekbang.org/resource/image/9d/b3/9df54dde5c41bf3b62567111f6f84bb3.jpg)
  - 流程
    - 题库生成模板
    - 题库推送模板：用于在秒杀前把题目提前推送给详情系统和交易系统。主要是为了保证每次用户请求的题目是唯一的，防止答题器作弊
    - 题目图片生成模块：把题目转成图片格式，并添加干扰因素。由于答题网络较为拥挤，要先把图片推送到CDN并且进行预热，否则用户请求题目时图片加载会很慢，影响体验
  - 优点 
    - 限制秒杀器作弊
    - 延缓请求，拉长峰值下单请求时间分片，减轻服务器压力
  ![](https://static001.geekbang.org/resource/image/0d/86/0d76780836ed220427a9370fce99f186.jpg)
  验证逻辑除了验证问题的答案以外，还包括用户本身身份的验证，例如是否已经登录、用户的 Cookie 是否完整、用户是否重复频繁提交等。提交答案的时间做些限制，若是在1s之内可能是非人为操作。

3. 分层过滤：在不同的层次过滤无效请求，“漏斗”最末端的才是有效请求（适用于交易性的写请求，例如减库存、拼车等）
  ![ ](https://static001.geekbang.org/resource/image/4a/09/4a5b7e080e7d357986f02ed1fd8b7309.jpg)
  - 过程
    - 大部分数据和流量在用户浏览器或者 CDN 上获取，这一层可以拦截大部分数据的读取
    - 经过第二层时数据尽量走Cache，过滤一些无效请求
    - 到第三层主要做数据的二次校验，对系统做好保护和限流
    - 最后在数据层完成强一致性校验
  - 校验原则
    - 将动态请求的读数据缓存（Cache）在 Web 端，过滤掉无效请求
    - 对读数据不做强一致性校验，减少因为一致性校验产生瓶颈的问题
    - 对写数据进行基于时间的合理分片，过滤掉过期的失效请求
    - 对写请求做限流保护，将超出系统承载能力的请求过滤掉
    - 对写数据进行强一致性校验，只保留最后有效的数据
  - 分层校验目的
    - 在读系统中，尽量减少由于一致性校验带来的系统瓶颈，但是尽量将不影响性能的检查条件提前，如用户是否具有秒杀资格、商品状态是否正常、用户答题是否正确、秒杀是否已经结束、是否非法请求、营销等价物是否充足等；在写数据系统中，主要对写的数据（如“库存”）做一致性检查，最后在数据库层保证数据（如“库存”）做一致性检查，最后在数据库层保证数据的最终准确性（如“库存”不能减为负数）
    

在削峰的处理方式上除了采用技术手段，其实还可以采用业务手段来达到一定效果，例如在零点开启大促的时候由于流量太大导致支付系统阻塞，这个时候可以采用发放优惠券、发起抽奖活动等方式，将一部分流量分散到其他地方，这样也能起到缓冲流量的作用。