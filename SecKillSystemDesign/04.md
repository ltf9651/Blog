## 04 | 二八原则：有针对性地处理好系统的“热点数据” 

**通过日志和数据分析判断，某商品是热点，即将有大量请求到来。把商品请求移交给秒杀系统，秒杀系统动静分离出html页面，和ajax请求**

- 热点
  - 热点操作：大量刷新页面、添加购物车、下单（读写请求）
  - 热点数据：热点请求对应的数据
      - 静态热点数据：能够提前预测的热点数据（分析）
      - 动态热点数据：不能提前预测的热点数据

- 发现热点数据
  - 静态热点数据
    - 通过分析、计算等预测热点，通过后台系统对商品进行预处理，提前进行缓存
    - 实时性差
  - 动态热点数据
    ![ ](https://static001.geekbang.org/resource/image/b6/1f/b62bd8bbdc2d2cded2df8adb857bf01f.jpg)
    通过部署在每台机器上的 Agent 把日志汇总到聚合和分析集群中，然后把符合一定规则的热点数据，通过订阅分发系统再推送到相应的系统中。可以把热点数据填充到 Cache 中，或者直接推送到应用服务器的内存中，还可以对这些数据进行拦截，总之下游系统可以订阅这些数据，然后根据自己的需求决定如何处理这些数据。
    - 系统实现
      - 构建一个异步系统，收集交易链路上各个环节中的中间件产品（Nginx、缓存、RPC 服务框架）的热点Key
      - 建立一个热点上报和可以按照需求订阅的热点服务的下发规范，主要目的是通过交易链路上各个系统（包括详情、购物车、交易、优惠、库存、物流等）访问的时间差，把上游已经发现的热点透传给下游系统，提前做好保护。比如，对于大促高峰期，详情系统是最早知道的，在统一接入层上 Nginx 模块统计的热点 URL。
      - 将上游系统收集的热点数据发送到热点服务台，然后下游系统（如交易系统）就会知道哪些商品会被频繁调用，然后做热点保护。
    - 注意点
      - 这个热点服务后台抓取热点数据日志最好采用异步方式，因为“异步”一方面便于保证通用性，另一方面又不影响业务系统和中间件产品的主流程。
      - 热点服务发现和中间件自身的热点保护模块并存，每个中间件和应用还需要保护自己。热点服务台提供热点数据的收集和订阅服务，便于把各个系统的热点数据透明出来。
      - 热点发现要做到接近实时（3s 内完成热点数据的发现），因为只有做到接近实时，动态发现才有意义，才能实时地对下游系统提供保护。

- 处理热点数据
  - 优化：缓存热点数据。（用队列短暂地缓存数秒钟，由于队列长度有限，采用LRU算法淘汰）
  - 限制：把热点商品限制在一个请求队列里，防止因某些热点商品占用太多的服务器资源（对商品ID做一致性Hash，然后根据 Hash 做分桶，每个分桶设置一个处理队列）
  - 隔离：不要让 1% 的请求影响到另外的 99%，隔离出来后也更方便对这 1% 的请求做针对性的优化。
    - 业务隔离：参与秒杀需要报名，报名后就有了已知热点，提前预热
    - 系统隔离：通过分组部署将秒杀请求与其他请求隔离，让请求落到不同的集群中
    - 数据隔离：启用单独的 Cache 集群或者 MySQL 数据库来放热点，目的也是不想 0.01% 的数据有机会影响 99.99%
    - 实现隔离办法
      - 按照用户来区分，给不同的用户分配不同的 Cookie，在接入层，路由到不同的服务接口中
      - 在接入层针对 URL 中的不同 Path 来设置限流策略。服务层调用不同的服务接口，以及数据层通过给数据打标来区分
