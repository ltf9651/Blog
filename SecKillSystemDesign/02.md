## 02 | 设计秒杀系统时应该注意的5个架构原则

**秒杀系统本质上就是一个满足大并发、高性能和高可用的分布式系统。架构是一种平衡的艺术，而最好的架构一旦脱离了它所适应的场景也是空谈。**

- 4要1不要
    1. 请求数据尽量少
        - 数据在网络传输中需要时间，不管是请求的数据还是返回的数据都需要在服务器做处理，服务在写网络时都要做压缩和字符编码，这些都非常消耗CPU，减少传输数据量可以减轻CPU的压力。例如可以简化页面，去掉不必要的装饰效果等。
        - 数据要尽量少”还要求系统依赖的数据能少就少数据要尽量少”还要求系统依赖的数据能少就少，包括和数据库打交道的读取、保存的数据。调用其他数据会涉及数据的序列化和反序列化，会增大CPU压力，也会增加延时。数据越简单、越小越好。
    1. 请求数尽量少
        - 合并CSS、JS等文件
        - 减少Ajax、图片请求
    1. 路径尽量短
        - 路径：用户发出请求到返回数据这个过程中，需求经过的中间的节点数。
        - 节点：系统或Socket连接。
        - 缩短路径可以增加可用性，减少数据的序列化和反序列化，减少网络传输延时。
        - 多个相互强依赖的应用合并部署在一起，把远程过程调用（RPC）变成 JVM 内部之间的方法调用。
    1. 依赖尽量少
        - 依赖（强依赖）：完成一次用户请求必须依赖的系统或服务。例如秒杀页面依赖商品、用户信息，不依赖优惠券列表
        - 可以通过系统分级较少依赖，如果1级系统最重要，那1级系统强依赖的系统也同样是最重要的系统
        - 1级系统要减少对其他级系统的依赖，防止被其他系统拖垮
    1. 不要有单点
        - 单点：没有备份，风险不可控
        - 避免单点：避免将服务的状态和机器绑定，即把服务无状态化，这样服务就可以在机器中随意移动。

- 秒杀系统架构
    - Version 1
        ![ ](https://static001.geekbang.org/resource/image/ba/3d/ba65c2b4e2a2bae28192e1d456131f3d.jpg)
        - 把秒杀功能单独拉打造成一个系统，减少依赖和复杂度。
        - 在秒杀系统部署上独立一个机器集群，不影响其他正常商品的购买。
        - 热点数据放入缓存。
        - 增加验证、答题，防止抢单机器刷点击。
    - Version 2
        ![ ](https://static001.geekbang.org/resource/image/50/65/5010fe68abebec4ed71e87147c0ee665.jpg)
        - 对页面彻底动静分离，使用户秒杀时不需要刷新整个页面，将数据刷新量减少
        - 服务端对秒杀商品进行缓存，不需要调用后台获取数据，甚至不需要去调用公共的缓存集群，可以减少系统调用，避免压垮公共缓存集群。（对商品进行缓存不适用于秒杀太多的商品，否则占用内存过多）
        - 增加限流保护