## 03 | 如何才能做好动静分离？有哪些方案可选？

**“动态数据”和“静态数据”的主要区别就是看页面中输出的数据是否和URL、浏览者、时间、地域等相关，以及是否含有Cookie等隐私数据**

- 静态数据缓存
    - 静态数据缓存到离用户最近的地方：浏览器、CDN、服务端的Cache
    - 静态化改造：直接缓存HTTP连接。 Web 代理服务器根据请求 URL，直接取出对应的 HTTP响应头和响应体然后直接返回，这个响应过程简单得连 HTTP协议都不用重新组装，甚至连 HTTP 请求头也不需要解析。
    - 选择合适的缓存处理工具：Nginx、Apache、Vanish等更擅长处理大并发的静态文件请求。

- 动静分离改造
    - URL唯一化：URL 作为 HTTP 缓存的 Key，例如以 id=xxx 这个格式进行区分。
    - 分离浏览者相关的因素：是否已登录、登录身份等相关因素单独拆分出来，通过动态请求获取。
    - 分离时间因素：服务端输出的时间通过动态请求获取。（因为时间要以服务端为准，客户端的时间用户可以自己修改）
    - 异步化地域因素：详情页面上与地域相关的因素做成异步方式获取。
    - 去掉Cookie：并非去除客户端接收到的Cookie，而是使缓存的静态数据中不含Cookie。（Vanish `unset req.http.cookie`)

- 动态数据处理
    - ESI(SSI)方案：在 Web 代理服务器上做动态内容请求，并将请求插入到静态页面中，当用户拿到页面时已经是一个完整的页面了。这种方式对服务端性能有些影响，但是用户体验较好。
    - CSI方案：单独发起一个异步 JavaScript 请求，以向服务端获取动态内容。这种方式服务端性能更佳，但是用户端页面可能会延时，体验稍差。

- 动静分离架构
    - 实体机单机部署
         ![ ](https://static001.geekbang.org/resource/image/4e/8a/4e4f0b0e5b83deaccb8cc49ad40f1a8a.jpg)
         将虚拟机改为实体机，增大Cache容量，采用一致性Hash分组的方式提高命中率。将Cache分组过少命中率虽高但容易导致Cache被击穿，采用多个分组达到平衡访问热点和命中率的问题。
         - 没有网络瓶颈，而且能使用大内存
         - 提高缓存命中率，减少Gzip压缩
         - 采用定时失效，减少Cache失效压力
         - 增加单机的内存容量，但是一定程度上也造成了 CPU 的浪费
         - 不易于维护
    - 统一 Cache 层
        ![ ](https://static001.geekbang.org/resource/image/36/d2/36af87e321f9d6a2f4516bf2e21e55d2.jpg)
        将单机的Cache统一分离，形成一个单独的Cache集群。
        - 优点
        - 单独一个 Cache 层，可以减少多个应用接入时使用 Cache 的成本。接入的程序只需关心如何使用，不必单独维护Cache。
        - 易于维护，加强监控、配置的自动化
        - 可以共享内存，最大化可利用内存，不同系统间的内存可以动态切换，从而有效应付各种攻击
        - Cache 层内部交换网络成为瓶颈
        - 缓存服务器的网卡也会是瓶颈
        - 机器少风险较大，挂掉一台就会影响很大一部分缓存数据
    - 上 CDN
        将 Cache 进一步前移到 CDN 上，选择 CDN 的二级 Cache 比较合适，因为二级 Cache 数量偏少，容量也更大，让用户的请求先回源的 CDN 的二级 Cache 中，如果没命中再回源站获取数据
        ![ ](https://static001.geekbang.org/resource/image/c0/dd/c0fd22cf9d565a8ea2e9edcefae3b2dd.jpg)
        - 需解决问题
            - 失效问题：如果缓存到错误且缓存时效很长，那用户端在很长一段时间内看到的都是错的，需要保证CDN可以在秒级时间内让分布在全国各地的Cache同时失效。
            - 命中率：Cache分布在CDN会导致请求访问命中同一Cache的命中率降低。
            - 发布更新：如果一个业务系统每周都有日常业务需要发布，那么发布系统必须足够简洁高效，且还需考虑出现问题可快速回滚和排查问题的便捷性。
        - 节点需满足条件
            - 靠近访问量比较集中的地区
            - 离主站相对较远
            - 节点到主站网络稳定
            - 节点容量大，不占用其他CDN太多资源
            - 节点不能太多

- 存储在浏览器和CDN上的区别
    - 在 CDN 上，可以做主动失效，而在用户的浏览器里就更不可控，如果用户不主动刷新的话，很难主动地把消息推送给用户
- 静态数据和动态数据合并并渲染的地方
    - 假如在用户的浏览器里合并，那么服务端可以减少渲染整个页面的 CPU 消耗。如果在服务端合并的话，就要考虑缓存的数据是否进行 Gzip 压缩了
    - 如果缓存 Gzip 压缩后的静态数据可以减少缓存的数据量，但是进行页面合并渲染时就要先解压，然后再压缩完整的页面数据输出给用户
    - 如果缓存未压缩的静态数据，这样不用解压静态数据，但是会增加缓存容量。