## 13 | 数据库表的空间回收

- InnoDB 表
  - 表结构定义 .frm
  - 数据

`innodb_file_per_table`
  - OFF 表的数据放在系统共享表空间，跟数据字典一起
  - ON  每个 InnoDB 表数据存储在一个以 .ibd 后缀的文件中
  - 默认为 ON，一个表单独存储一个文件更容易管理，`drop table`时系统直接删除这个文件。如果放在共享表空间，即使表删除了空间也不会回收

### 数据删除流程

 InnoDB 的数据是按页存储的，如果删掉了一个数据页上的所有记录，整个数据页可以复用

 数据页的复用跟记录的复用不同
   - 记录的复用只限于符合范围条件的数据
   - 数据页的复用可以服用到任何位置

 `delete` 命令其实只是把记录的位置，或者数据页标记为了“可复用”，如果插进来一个 ID 位于左右 ID 范围之内的数据则可以直接复用这个空间，当整个页从 B+ 树里面摘掉以后，可以复用到任何位置。但磁盘文件的大小是不会变的。

 `delete` 不会回收表空间

 如果数据是按照索引递增顺序插入的，那么索引是紧凑的。但如果数据是随机插入的，就可能造成索引的数据页分裂

### 回收空间

 - `alter table A engine=InnoDB`
 - Online DDL 重建表流程
    - 建立一个临时文件，扫描表 A 主键的所有数据页；
    - 用数据页中表 A 的记录生成 B+ 树，存储到临时文件中；
    - 生成临时文件的过程中，将所有对 A 的操作记录在一个日志文件（row log）中，对应的是图中 state2 的状态；
    - 临时文件生成后，将日志文件中的操作应用到临时文件，得到一个逻辑数据上与表 A 相同的数据文件，对应的就是图中 state3 的状态；
    - 用临时文件替换表 A 的数据文件。

- Truncate 可以理解为 drop+create
