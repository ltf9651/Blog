## 04 | 深入浅出索引（上）

### 索引分类

1. 索引的作用：提高数据查询效率
1. 常见索引模型
   - 哈希表
     - 结构：键 - 值 (key - value)
     - 把值放在数组里，用一个哈希函数把 key 换算成一个确定的位置，然后把 value 放在数组的这个位置
     - 哈希冲突的处理办法：拉出一个链表
     - 适用场景：只有等值查询的场景
   - 有序数组
     - 按顺序存储。查询用二分法就可以快速查询，时间复杂度是：O(log(N))
     - 适用于等值查询、范围查询
     - 查询效率高，更新效率低
     - 适用场景：静态存储引擎（不会轻易修改的数据）
   - 搜索树
     - 二叉树：每个节点的左儿子小于父节点，父节点又小于右儿子
     - 搜索效率最高
     - 查询时间复杂度 O(log(N))，更新时间复杂度 O(log(N))
     - 数据库存储大多不适用二叉树，因为索引不止存在内存，还要写到磁盘
     - N 叉树可以让查询过程访问尽量少的数据库从而更少的度磁盘，性能高

### InnoDB 中的索引模型：B+Tree

在 InnoDB 中，表都是根据主键顺序以索引的形式存放，这种存储方式称为索引组织表

索引类型：
  - 主键索引（聚簇索引）：叶子节点存的是整行数据
  - 非主键索引（二级索引）：叶子节点内容为主键的值

基于主键索引和普通索引的查询的区别
  - 如果语句是 `select * from T where ID = 5`，即主键查询方式，则只需要搜索 ID 这棵 B+ 树；
  - 如果语句是 `select * from T where k = 5`，即普通索引查询方式，则需要先搜索 k 索引树，得到 ID 的值为 5，再到 ID 索引树搜索一次。这个过程称为回表

基于非主键索引的查询需要多扫描一棵索引树。因此，在应用中应该尽量使用主键查询

### 索引维护

设置自增主键的意义：减少数据页分裂

页分裂：插入一个 ID 较小的数据行时，如果所在的数据页已满，根据 B+ 树的算法，需要申请一个新的数据页，然后挪动部分数据过去

页分裂影响数据页的利用率，原本放在一个页的数据，现在分到两个页中，整体空间利用率降低 50%

页合并：当相邻两个页由于删除了数据，利用率很低之后，会将数据页做合并

主键长度越小，普通索引的叶子节点就越小，普通索引占用的空间也就越小

有没有什么场景适合用业务字段直接做主键的呢？还是有的。比如，有些业务的场景需求是这样的：
- 只有一个索引；
- 该索引必须是唯一索引。

这就是典型的 KV 场景。

由于没有其他索引，所以也就不用考虑其他索引的叶子节点大小的问题

这时候就要优先考虑上一段提到的“尽量使用主键查询”原则，直接将这个索引设置为主键，可以避免每次查询需要搜索两棵树

```
// 1
alter table T drop index k;
alter table T add index(k);

// 2
alter table T drop primary key;
alter table T add primary key(id);

- 重建索引可以使页面利用率提高，空间更紧凑
- 删除或者新建主键索引，会重建这个表
- 删除重建普通索引貌似影响不大，不过要注意在业务低谷期操作，避免影响业务
- 使用 `alter table T engine=InnoDB` 替代
```
