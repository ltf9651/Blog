## 01 | 基础架构

![基础架构](https://static001.geekbang.org/resource/image/0d/d9/0d2070e8f84c4801adbfa03bda1f98d9.png)

### MySQL 可以分为 Server 层和存储引擎层两部分

  - Server 层：涵盖 MySQL 的大多数核心服务功能，内置函数，跨存储引擎等功能
    - 连接器：负责跟客户端建立连接、获取权限、维持和管理连接
    - 查询缓存：查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空，对于更新压力大的数据库来说，查询缓存的命中率会非常低 (**MySQL8.0 之后不再有查询缓存功能**)
    - 分析器：词法分析、语法分析
    - 优化器：优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序
    - 执行器：权限验证、执行计划
  - 存储引擎层：负责数据的存储和提取

- `wait_timeout` 控制自动断开与客户端连接的时长
- 尽量使用长连接：建立连接过程复杂
  - 全部使用长连接会造成内存占用大，被系统强行杀掉（OOM），造成 MySQL 异常重启
  - 优化
    - 定期断开长连接，或者程序判断执行过一个占用内存大的查询后，断开重连
    - 在执行大操作后执行 `mysql_reset_connection` 重新初始化连接资源，这个过程不需要重连和权限验证，会将连接恢复到刚创建完的状态

### 查询缓存

- MySQL 接收到查询请求后，先到查询缓存查询是否执行过此 SQL，之前执行过的语句及结果会以 key-value 对的形式缓存在内存中
- 查询缓存利大于弊
  - 失效非常频繁，只要对一个表更新，表上所有的查询缓存都会被清空
  - 对于更新压力大的库，命中率非常低
  - 静态表，不经常更新的适合查询缓存
- MySQL8.0 弃用查询缓存

### 分析器

词法分析：判断输入 SQL 是否满足 MySQL 语法

### 优化器

- 决定使用哪个索引
- 多表关联（join）的时候决定各个表的连接顺序

### 执行器

- 开始执行 SQL 时，首先判断对表有没有执行权限
- 根据表的引擎定义，使用引擎提供的接口
  1. 调用 InnoDB 引擎接口取这个表的第一行，判断 where 是否满足， 不是则跳过，是则将这行存在结果集中
  1. 调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到表的最后一行
  1. 执行器将上述遍历过程所有满足条件的行组成的记录集作为结果返回给客户端
- `rows_examined` 执行过程扫描了多少行
