## 12 | Mysql“抖”一下

- 情况：一条 SQL 语句，正常执行的时候特别快，但是有时也不知道怎么回事，它就会变得特别慢，并且这样的场景很难复现，它不只随机，而且持续时间还很短
- 脏页：当内存数据页跟磁盘数据页内容不一致，这个内存页为脏页
- 将脏页 flush 到磁盘上是直接将脏页数据覆盖到对应磁盘上的数据

- redo log 写满了，系统会停止更新操作，要 flush 脏页
    - 出现这种情况的时候，整个系统就不能再接受更新了，所有的更新都必须堵住
    - 可通过增大 redo log 体积解决
- 内存不够用时，要先将脏页写到磁盘
- 当要读入的数据页没有在内存的时候，就必须到缓冲池中申请一个数据页。这时候只能把最久不使用的数据页从内存中淘汰掉
- 更新操作多，系统内存不足时，需要新的内存页时要淘汰一些数据页空出内存，如果要淘汰的是一个干净页，就直接释放出来复用；但如果是脏页，就必须将脏页先刷到磁盘，变成干净页后才能复用
- MySQL 正常关闭的时候会把内存脏页 flush 到磁盘，下次启动时就直接从磁盘读数据，启动速度很快

### InnoDB 刷脏页的控制策略

- 刷盘速度参考因素
  - 脏页比例：`innodb_max_dirty_pages_pct` 脏页比例上限，默认是 75%
  - redo log 写盘速度：`innodb_io_capacity` 建议设为磁盘的 IOPS

```
//使用fio测试IOPS写盘速度
fio -filename=$filename -direct=1 -iodepth 1 -thread -rw=randrw -ioengine=psync -bs=16k -size=500M -numjobs=10 -runtime=10 -group_reporting -name=mytest
```

`innodb_flush_neighbors` 控制刷脏页时是否把其他脏页一起刷掉，如果是 SSD 这种 IOPS 较高的设备，设为 0，只刷自己，减少 SQL 语句响应时间
