## 10 | MySQL 索引选择策略

选择索引是优化器的工作。而优化器选择索引的目的，是找到一个最优的执行方案，并用最小的代价去执行语句。在数据库里面，扫描行数是影响执行代价的因素之一。扫描的行数越少，意味着访问磁盘数据的次数越少，消耗的 CPU 资源越少。

当然，扫描行数并不是唯一的判断标准，优化器还会结合是否使用临时表、是否排序等因素进行综合判断。

```sql
select * from t where a between 10000 and 20000; /*Q1*/
select * from t force index(a) where a between 10000 and 20000;/*Q2*/

Q1: key:null   row:30000+
Q2: key: a     row:10001
```

- MySQL 选错索引，还得归咎到没能准确地判断出扫描行数
- 一个索引上不同的值越多，区分度就越好
- 如果使用索引 a，每次从索引 a 上拿到一个值，都要回到主键索引上查出整行数据，这个代价优化器也要算进去的。
- 如果选择扫描 10 万行，是直接在主键索引上扫描的，没有额外的代价。
- 优化器会估算这两个选择的代价，从结果看来，优化器认为直接扫描主键索引更快。当然，从执行时间看来，这个选择并不是最优的。

- 解决
  - `analyze table` 重新统计索引信息
  - `force index`
  - 修改语句，引导 MySQL 使用期望的索引
  - 新建一个更合适的索引，来提供给优化器做选择，或删掉误用的索引
