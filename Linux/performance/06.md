## 软中断（softirq）

中断：一种异步的事件处理机制，可以提高系统的并发处理能力。为了减少对正常进程运行调度的影响，中断处理程序就需要尽可能快地运行

中断处理程序在响应中断时，会临时关闭中断，会导致上一次中断处理完成之前其他中断都不能响应，可能造成中断丢失

### 软中断

- 上半部阶段
  - 硬中断，直接处理硬件请求
  - 快速处理中断，在中断禁止模式下运行，主要处理跟硬件紧密相关的或时间敏感的工作
  - 打断 CPU 正在执行的任务，立即执行中断处理程序
- 下半部阶段
  - 软终端，内核触发
  - 延迟处理上半部未完成的工作，通常以内核线程的方式运行
  - 软中断包括网络收发、定时、调度、RCU 锁等各种类型

每个 CPU 都对应一个软中断内核线程，名字为 ksoftirqd/cpu 编号

### 查看软中断和内核线程

proc 文件系统：一种内核空间和用户空间进行通信的机制，可以用来查看内核的数据结构或者动态修改内核的配置
 - `/proc/softirqs` 提供软中断的运行情况
 - `/proc/interrupts` 提供硬中断的运行情况

```sh
# 各种类型软中断在不同 CPU上的累积运行次数
> cat /proc/softirqs

                CPU0       CPU1
      HI:          0          0
   TIMER: 3470221042 3395816892
  NET_TX:          0          0
  NET_RX: 2101387064 1259710228
   BLOCK:          0          0
BLOCK_IOPOLL:          0          0
 TASKLET:        314          0
   SCHED:  618166460  564272309
 HRTIMER:    1375771    1288452
     RCU: 3679285046 3600888142.

```

当软中断事件的频率过高时，内核线程也会因为 CPU 使用率过高而导致软中断处理不及时，进而引发网络收发延迟，调度缓慢等性能问题

sar：系统活动报告工具，既可以实时查看系统的当前活动，又可以配置保存和报告历史统计数据

hping3：可以构造 TCP/IP 协议数据包的工具，可以对系统进行安全审计、防火墙测试等

tcpdump：常用的网络抓包工具，常用来分析各种网络问题
