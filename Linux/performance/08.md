## 内存

内存主要用来存储系统和应用程序的指令、数据、缓存

### 内存映射

只有内核才可以直接访问物理内存，进程通过虚拟内存访问内存，只有实际使用的虚拟内存才分配物理内存，分配后通过内存映射来管理

Linux 内核给每个进程都提供一个独立的虚拟地址空间，并且这个地址空间的是连续的

虚拟地址空间分为内核空间和用户空间

进程在用户态时只能访问用户空间内存，只有进入内核状态才可以访问内核空间内存

每个进程的地址空间都包含了内核空间，但这些内核空间其实关联的都是相同的物理内存，这样进程切换到内核态后就可以很方便的访问内核空间内存

内存映射：将虚拟内存地址映射到物理内存地址

### 虚拟内存空间分布

用户空间内存段
  - 只读段：代码、常量等
  - 数据段：全局变量等
  - 堆：动态分配的内存，从低地址开始向上增长
  - 文件映射段：动态库、共享内存等，从高地址开始向下增长
  - 栈：局部变量和函数调用的上下文等，大小固定，一般是 8MB

### 内存分配和回收

`malloc()`：C 标准库的内存分配函数
  - 对于小块内存（小于 128K），使用`brk()`分配，通过移动堆顶的位置分配内存，内存释放后不会立刻归还系统，而是被缓存起来以便重复使用
    - 可以减少缺页异常的发生
    - 提高内存访问效率
    - 内存没有归还系统，在内存工作繁忙时，频繁的内存分配和释放会造成内存碎片
  - 对于大块内存（大于 128K），直接使用内存映射`mmap()`，在文件映射段找一块空间内存分配出去
    - 释放时直接归还系统，所以每次`mmap`都会发生缺页异常
    - 内存工作繁忙时会导致大量缺页异常，内核管理负担增大
  - 当这两种调用发生后，其实并没有真正分配内存
  - 这些内存，都只在首次访问时才分配，也就是通过缺页异常进入内核中，再由内核来分配内存
  - 内存只分配不释放会造成泄露，使用后应调用`free()`或者`unmap()`释放无用内存

回收机制
  - 回收缓存，LRU 算法回收最近使用最少的内存页面
  - 回收不常访问的内存，把不常用的内存通过减缓分区直接写到磁盘
  - 杀死进程，内存紧张时系统通过 OOM（Out of memory）直接杀掉占用大量内存的进程

Swap：交换分区，把一块磁盘空间当成内存使用，可以把进程暂时不用的数据存储到磁盘中，当进程访问这些内存时再从磁盘读取数据到内存

通常只在内存不足时才会发生 Swap，由于磁盘读写速度慢，Swap 会导致严重的内存性能问题

OOM
  - 一个进程消耗的内存越大，oom_score 越大
  - 一个进程运行占用的 CPU 越多，oom_score 越小

进程的 oom_score 越大代表小号的内存越多，越容易被杀死

### 查看内存使用情况

```sh
> free
             total       used       free     shared    buffers     cached
Mem:       8193288    7369380     823908      65964     682968    2812244
-/+ buffers/cache:    3874168    4319120
Swap:            0          0          0

```

- total：总内存大小
- used：已使用内存大小，包含共享内存
- free：未使用的内存大小
- shared：共享内存的大小
- buff/cache：缓存和缓冲区的大小
- available：新进程可用内存的大小

```sh
> top

  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND
22074 root      10 -10  141m  23m 6328 S  1.0  0.3   1560:30 AliYunDun

```

- VIRT：进程虚拟内存的大小
- RES：常驻内存大小，也就是进程实际使用的物理内存大小，但不包括 Swap 和共享内存
- SHR：共享内存的大小
- %MEM：进程使用物理内存占系统总内存的百分比

### Buffers 和 Cache

/proc 是 Linux 内核提供的一种特殊文件系统，是用户和内核交互的接口

Buffers
  - 对磁盘数据的缓存
  - 内核缓冲区用到的内存，对应 /proc/meminfo 中的 Buffers 值
  - 对原始磁盘块的临时存储，用来缓存磁盘的数据
  - 内核可以把分散写集中，统一优化磁盘写入，合并多次小写成单次大的写
  - 既可以用作“将要写入磁盘数据的缓存”，也可以作为“从磁盘读取数据的缓存“

Cache
  - 对文件数据的缓存
  - 内核页缓存和 Slab 用到的内存，对应 /proc/meminfo 中的 Cached 和 SReclaimable 之和
  - 从磁盘读取文件的页缓存，用来缓存从文件读取的数据
  - 下次访问文件时，直接从内存中快速获取而不需要再次访问缓慢的磁盘
  - 既可以用作“从文件读取数据的页缓存”，也可以用作“写文件的页缓存”

` echo 3 > /proc/sys/vm/drop_caches`：清理系统缓存
