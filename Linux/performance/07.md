## CPU 瓶颈分析和优化

### CPU 性能指标

- CPU 使用率
  - 用户 CPU 使用率
    - 用户态 CPU 使用率（user）
    - 低优先级用户 CPU 使用率（nice）
  - 系统 CPU 使用率
    - CPU 在内核态运行的时间百分比，高说明内核繁忙
  - 等待 I/O 和 CPU 使用率
    - iowait 高说明系统和硬件的 I/O 交互时间较长
  - 软终端和硬中断的 CPU 使用率
    - 高说明系统发生大量中断
- 平均负载（Load Average）
  - 系统的平均活跃进程数
  - 理想情况下平均负载等于逻辑 CPU 个数
- 进程上下文切换
  - 自愿上下文切换
  - 非自愿上下文切换
- CPU 缓存命中率
  - CPU 速度大于内存，CPU 缓存的速度介于 CPU 和内存之间
  - 缓存按照大小分为 L1，L2，L3，L1 和 L2 常用在单核，L3 用在多核
  - 从 L1 到 L3，三级缓存的大小依次增大，性能依次降低

### 优化方法

三步走
 - 确定性能的量化指标－一般从应用程序纬度和系统资源纬度分析
 - 测试优化前的性能指标
 - 测试性能优化后的性能指标

排除所有不必要的工作，只保留最核心的逻辑，比如减少循环的层次，减少递归，减少动态内存分配等等
  - 编译器优化
  - 算法
  - 异步
  - 多线程代替多进程
  - 缓存
  - CPU 绑定：把进程绑定到一个或多个 CPU 上，提高 CPU 缓存命中率，减少上下文切换
  - CPU 独占：将 CPU 分组，并通过 CPU 亲和性机制为其分配进程
  - 优先级调整
  - 为进程设置资源限制
  - NUMA（Non-Uniform Memory Access）
  - 中断负载均衡
