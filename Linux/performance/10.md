## Swap

系统的内存资源紧张时，系统应对策略
  - 内存回收
    - 文件页：缓存和缓冲区等可回收内存
    - 对于被程序修改过，并且暂时没写入磁盘的数据（脏页）进行刷盘，然后释放
      - `fsync`同步刷盘
      - `pdflush`脏页刷新
    - 回收匿名页：应用程序动态分配的堆内存
    - Swap：把不常用的内存先写入磁盘，后释放内存给其他需要的进程，再次访问这些内存时重新从磁盘读入内存
  - OOM 杀死进程

### Swap 原理

Swap
 - 换出：把进程暂时不用的内存数据存储到磁盘，并释放这些数据占用的内存
 - 换入：在进程再次访问这些内存的时候，把它们从磁盘读到内存中

回收内存
  - 直接内存回收
  - 定期回收内存：`kswapd0`

### NUMA 与 SWAP

NUMA（Non-Uniform Memory Access）：多个处理器被划分到不同 Node，每个 Node 都有自己的本地内存空间

```sh
> numactl --hardware
available: 1 nodes (0)
node 0 cpus: 0 1
node 0 size: 8191 MB
node 0 free: 658 MB
node distances:
node   0
  0:  10
```

NUMA 架构下每个 Node 都有自己本地内存空间，当本地内存不足时，默认即可以从其他 Node 寻找空闲内存，也可以从本地内存回收

`/proc/sys/vm/zone_reclaim_mode`：调整 NUMA 本地内存回收策略

对于文件页，直接回收缓存或者把脏页写回磁盘后在释放

对于匿名页，通过 Swap 机制写入磁盘后在释放，下次访问时再从磁盘换入内存

Swap 是针对以前内存小的一种优化，减少写的次数，延长 Flash 存储寿命，目前内存没那么昂贵之后就没那么大的必要开启

NUMA 是对系统资源做的隔离分区，目前虚拟化和 docker 流行且 Node 与 Node 之间访问更耗时，针对大程序不一定起到了优化作用，针对小程序，也没有太大必要开启
