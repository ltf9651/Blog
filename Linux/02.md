### ARO 协议工作原理

- ARP 能实现人物网络层地址到任意物理地址的转换
- 工作原理：主机向自己所在的网络广播一个 ARP 请求，该请求包含目标机器的网络地址，此网络上的其他机器都将收到这个请求，但只有被请求的目标机器会回应一个 ARP 请求，其中包含自己的物理地址

#### 以太网 ARP 请求 / 应答报文

- 报文字段
  - 硬件类型：定义物理地址的类型，值为 1 表示 MAC 地址，2 字节
  - 协议类型：表示要映射的协议地址类型，值为 0x800，表示 IP 地址，2 字节
  - 硬件地址长度，1 字节
  - 协议地址长度，1 字节
  - 操作：ARP 请求（值为 1），ARP 应答（值为 2），RARP 请求（3），RARP 应答（4），2 字节
  - 发送端以太网地址，6 字节
  - 发送端 IP 地址，4 字节
  - 目的端以太网地址，6 字节
  - 目的端 IP 地址，4 字节
- ARP 请求 / 应答报文长度为 28 字节，如果再加上以太网帧头部和尾部的 18 字节，则一个携带 ARP 请求 / 应答报文的以太网帧长度为 46 字节

#### ARP 高速缓存的查看和修改

- ARP 维护一个高速缓存，包含经常访问或最近访问的 IP 地址到物理地址的映射，可避免重复的 ARP 请求，提高发送数据包的速度
- 可使用 `arp` 命令查看和修改缓存

#### 使用 tcpdump 观察 ARP 通信过程

```sh
arp -d 192.168.1.109 #清除ARP缓存
tcpdump -i eth0 -ent '{dst 192.168.1.109 and src 192.168.1.108} or {dst 192.168.1.108 and src 192.168.1.109}'

# 另一个终端
telnet 192.168.1.109 echo
```

### DNS 工作原理

#### DNS 查询和应答报文

- DNS 是分布式域名服务系统，每个 DNS 服务器都存放大量的机器名和 IP 地址的映射，且动态更新
- DNS 报文头部 16 位标识字段
  - QR：查询 / 应答标志，0 表示查询，1 表示应答
  - opcedo：查询和应答的类型，0 标准查询，1 反向查询（由 IP 地址获得域名），2 请求服务器状态
  - AA：授权应答标志，仅由应答报文使用，1 表示域名服务器是授权服务器
  - TC：截断标志，仅当 DNS 报文使用 UDP 服务时使用，1 表示 DNS 报文超过 512 字节并被截断
  - RD：递归查询标志。1 表示执行递归查询，即如果目标 DNS 服务器无法解析某个主机名，则他将向其他 DNS 服务器继续查询，如此递归直到获得结果并把结果返回给客户端。0 表示迭代查询，即如果目标 DNS 服务器无法解析某个主机名则将自己知道的其他 DNS 服务器 IP 地址返回给客户端，供客户端参考
  - RA：允许递归标志，仅由应答报文使用，1 表示 DNS 服务器支持递归查询
  - zero：3 位未用，必须都设为 0
  - rcode：4 位返回码，表示应答的状态。0 无错误，3 域名不存在
- 其它字段
  - 查询问题
  - 应答（RR）
  - 授权（RR）
  - 额外信息（RR）
- RR：资源记录格式
  - 32 位域名：该记录中与自愿对应的名字，格式和查询问题中的查询名字段相同
  - 16 位类型：与 DNS 查询问题的对应字段相同
  - 32 位生存时间：该查询记录结果可被本地客户端程序缓存多长时间，单位秒
  - 16 位资源数据长度：取决于类型，以字节为单位，对于类型 A 为 4 字节
  - 资源数据：取决于类型，对于类型 A 为 32 位的 IPv4 地址
- 查询类型
  - 类型 A：值为 1，表示获取目标主机的 IP 地址
  - 类型 CNAME：5，表示获得目标主机的别名
  - 类型 PTR：12，表示反向查询

#### Linux 访问 DNS

```sh
# /etc/resolv.conf 存放DNS服务器的IP地址
host -t A www.baidu.com
```

```sh
tcpdump -i eth0 -nt -s 500 port domain
host -t A www.baidu.com
```

#### socket

- socket 网络编程接口
  - 将应用程序数据从用户缓冲区复制到 TCP/UDP 内核发送缓冲区，以交付内核发送数据。或者从内核 TCP/UDP 内核接收缓冲区复制数据到用户缓冲区以读取数据
  - 应用程序可以通过他们来修改内核中各层协议的某些头部信息或其他数据结构，从而精确地控制底层通信的行为
