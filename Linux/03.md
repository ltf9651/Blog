## IP 协议详解

- IP 头部信息：指定 IP 通信的源端 IP 地址，目的端 IP 地址
- IP 数据包的路由和转发：路由和转发发生在除目标机器之外的所有主机和路由器上，决定数据包是否应该转发以及如何转发

### IP 服务特点

- IP 协议是 TCP/IP 协议族的动力，为上层协议提供无状态、无连接、不可靠的服务
- 无状态
  - IP 通信双方不同步传输数据和状态信息，所有 IP 数据包的发送、传输和接收都是相互独立，没有上下文关系
  - 缺点：无法处理乱序和重复的 IP 数据包
  - 优点：简单高效，无须为保持通信的状态分配一些内河资源，也无须每次传输数据时都携带状态信息
- 无连接
  - IP 通信双方都不长久地维持对方的任何信息，上层协议每次发送数据都必须明确指定对方的 IP 地址
- 不可靠
  - 不能保证 IP 数据包准确到达接收端

### IPv4 头部结构

- 16 位总长度：整个 IP 数据报的长度，单位字节，因此最大长度为 65535(2^16-1)
  - 4 位版本号（version）：指定 IP 协议版本
  - 4 位头部长度（header length）：标识该 IP 头部有多少个 32bit(4 字节），因为 4 位最大能表示 15，IP 头部最长 60 字节
  - 8 位服务类型（Type Of Service）
    - 3 位的优先权字段
    - 4 位的 TOS 字段
      - 最小延时
      - 最大吞吐量
      - 最高可靠性
      - 最小费用
    - 1 位的保留字段：值为 0

- 分片
  - 16 位标识（identification）：唯一地标识主机发送的每一个数据包，初始值由系统随机生成，每发送一个数据包就加 1，该值在数据报分片时被复制到每个分片中，因此同一个数据报的所有分片都具有相同的标识值
  - 3 位标志字段的第一位保留
  - 13 位分片偏移：分片相对原始 IP 数据报开始出的偏移
  - 8 位生存时间：数据报到达目的地之前允许经过的路由器跳数
  - 8 位协议：区分上层协议
  - 16 位头部校验和发送端填充：接收端对其使用 CRC 算法检验头部在传输中是否损坏
  - 32 为的源端 IP 地址和目的端 IP 地址：标识数据报发送端和接收端

- IPv4 头部选项字段：可变长度，最多包含 40 字节
  - 记录路由：告诉数据报途经的所有路由器都将自己的 IP 地址填入 IP 头部的选项部分，可以跟踪数据报的传递路径
  - 时间戳：告诉每个路由器都将数据报被转发的时间填入头部选项部分，可测量途经路由的之间数据报传输的时间
  - 松散源路由选择：指定一个路由器 IP 地址列表，数据报发送过程必须经过其中所有的路由器
  - 严格源路由选择：数据报只能经过被指定的路由器

### IP 分片

- 当 IP 数据报的长度超过帧的 MTU（1500 字节） 时，将被分片传输
- 分片可能发生在发送端、中转路由器上，而且可能在传输过程中被多次分片，但只有在最终目标机器上这些分片才会被内核中的 IP 模块重新组装
- IP 头部的三个字段给 IP 分片和重组提供信息
  - 数据报标识
  - 数据报表标志
  - 片偏移
- 以太网帧携带的 IP 数据报数据部分最多 1480 字节（1500-IP 头部占用 20）
- IP 层传递给数据链路层的数据可能是一个完整的 IP 数据报，也可能是一个 IP 分片，统称为 IP 分组（packet）

### IP 路由

- 数据报路由：决定发送数据包到目标机器的路径

#### IP 模块工作流程

- 当 IP 模块接收到来自数据链路层的 IP 数据包时，首先对该数据报头部做 CRC 校验，确认无误后分析其头部具体信息
- 若该数据包头部设置了源路由选择（松散 / 严格），则 IP 模块调用数据报转发子模块来处理该数据包
- 若该数据包头部中目标 IP 地址为本机的某个 IP 地址或广播地址，即该数据包时发送给本机的，则根据数据包头部中的协议字段决定将它派发给哪个上层应用
- 若不是发送给本机，则也调用数据报转发子模块来处理
- 数据报转发子模块首先检测系统是否允许转发，若不允许直接将数据报丢弃；若允许将对该数据执行一些操作然后将它交给 IP 数据报输出子模块
- 路由过程：IP 数据报发送至哪个下一跳路由以及经过哪个网卡
- 路由表：IP 模块实现数据报路由的核心数据结构，按照数据报的目标 IP 地址分类，同一类型的 IP 数据报将被发往相同的下一跳路由器
- IP 输出队列：存放所有等待发送的 IP 数据报，除了需要转发的 IP 数据报外，还包括封装了本机上层数据（ICMP 报文、TCP 报文段、UDP 数据报）的 IP 数据报

#### 路由机制

```sh
> route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use    Iface
default         *               255.255.0.0     U     1002   0        0     eth0
192.168.1.0     *               255.255.0.0     U     0      0        0     eth0
default         10.168.255.253  0.0.0.0         UG    0      0        0     eth0
```

- 路由表内容
  - Destination：目标网络或主机
  - Gateway：网关地址，*标识目标和本机在同一个网络，不需要路由
  - Genmask：网络掩码
  - Flags
    - U：该路由项是活动的
    - H：该路由项的目标是一台主机
    - G：该路由项的目标是网关
    - D：该路由项是由重定向生成的
    - M：该路由项被重定向修改过
  - Metric：路由距离，即到达指定网络所需要的中专数
  - Ref：路由项被引用次数（Linux 未使用）
  - Use：该路由项被使用的次数
  - Iface：该路由项对应的输出网卡接口

- 路由步骤
  1. 查找路由表中的数据报的目标 IP 地址完全匹配的主机 IP 地址，若找到就使用该路由项，找不到跳转 2.
  2. 查找路由表中和数据报的目标 IP 地址具有相同网路 ID 的网络 IP 地址，若找到就使用该路由项，找不到跳转 3.
  3. 选择默认路由项，通常意味着数据报下一跳路由是网关

#### 路由表更新

```sh
> route add -host 192.168.1.1 dev eth0
> route del -net 192.168.1.0 netmask 255.255.255.0
> route del default
> route add default gw 192.168.1.1 dev eth0
```

### IP 转发

1. 检查数据报头部的 TTL 值，若为 0 则丢弃该数据
1. 查看数据报头部的严格源路由选择项，若被设置，则检测数据包的目标 IP 地址是否是本机的某个 IP 地址，若不是发送一个 ICMP 源战选录失败报文给发送端
1. 若有必要给源端发送一个 ICMP 重定向报文，告诉他一个更合理的下一跳路由器
1. 将 TTL 值减 1
1. 处理 IP 头部选项
1. 如有必要，执行 IP 分片

### 重定向

#### ICMP 重定向报文

- 路由器发送 ICMP 重定向报文
- 主机接收 ICMP 重定向报文
- 重定向报文数据
  - 引起重定向的 IP 数据报的源端 IP 地址
  - 应该使用的路由器 IP 地址

### IPv6 头部结构

- IPv6 解决了 IPv4 地址不够用的问题，IPv6 用 128 位（16 字节）标识地址，使 IP 地址总量达 2^128 个
- 增加了多播和流的功能
- 引入自动配置，更方便管理局域网
- 增加了专门的网络安全功能

#### IPv6 固定头部结构

- 40 字节固定头部
  - 4 位版本号：指定 IP 协议版本，对 IPv6 来说，值为 6
  - 8 位通信类型：指示数据流通信类型或优先级，与 IPv4 的 TOS 类似
  - 20 位流标签：用于某些对连接的服务质量有特殊要求的通信，例如音频、视频等实时数据传输
  - 16 位净荷长度：IPv6 扩展头部和应用程序数据长度之和，不包括固定头部长度
  - 8 位下一个包头：紧跟 IPv6 固定头部后的包头类型
  - 8 位跳数限制：与 IPv4 的 TTL 含义相同

#### IPv6 扩展头部结构

- 一个数据报可包含多个扩展头部
  - Hop-by-Hop：逐跳选项头部，包含每个路由器都必须检查和处理的特殊参数选项
  - Destination options：目的选项头部，指定由最终目的节点处理的选项
  - Routing：路由头部，指定数据包要经过哪些中转路由器
  - Fragment：分片头部，处理分片和重组的细节
  - Authentication：认证头部，提供数据源认证、数据完整性检查和反重播保护
  - Encapsulating Security Payload：加密头部
  - No next header：没有后续扩展头部
