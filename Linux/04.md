## TCP 协议详解

### TCP 服务的特点

- 传输层协议
  - TCP：面向连接、字节流，可靠传输
  - UDP
- 使用 TCP 通信的啥 UN 官方必须先建立连接，然后才能开始数据的读写，双方都必须为该连接分配必要的内核资源以管理连接的状态和连接上数据的传输
- 完成数据交换后通信双方都必须断开连接以释放系统资源
- TCP 的连接是一对一，不适用于广播、多播
- 无连接的 UDP 适合于广播、多播
- 当发送端应用程序连续执行多次写操作时，TCP 模块将数据放入 TCP 发送缓冲区
- 当 TCP 模块真正开始发送数据时，发送缓冲区中这些等待发送的数据被封装成一个或多个 TCP 报文段发出
- 当接收端收到一个或多个 TCP 报文段后，TCP 模块将他们携带的数据按照 TCP 报文段的序号依次放入 TCP 接收缓冲区，并通知程序读取数据
- 接收端可一次读取出全部数据，也可分多次读取，取决于用户指定的应用程序读缓冲区的大小
- 发送端程序每执行一次写操作，UDP 就将其封装成一个 UDP 数据并发送，接收端必须及时针对每一个 UDP 数据执行读操作否则会丢包，若没有指定足够的应用程序缓冲区来读取则 UDP 数据将被截断
- TCP 可靠性
  - 采用发送应答机制：发送端发送的每个 TCP 报文段都必须得到接收方的应答才认为 TCP 报文段传输成功
  - 超时重传：发送端在发送一个 TCP 报文段后启动定时器，如果在定时时间内未接收到应答则重发
  - TCP 报文段以 IP 数据报发送，对于可能出现的乱序、重复 TCP 协议会对接收到的数据进行重排、整理再交付给应用层

### TCP 头部结构

#### 固定头部结构

- 16 位源端口号：告知主机该报文段源端口
- 16 位目的端口号：告知主机该报文段传给哪个上层协议或目的端口
- 32 位序号：一次 TCP 通信过程中某一个传输方向上的字节流的每个字节的编号
- 32 位确认号：用于对另一发发送的报文段的响应，其值为收到的 TCP 报文段的序号值加 1
- 4 位头部长度：标识 TCP 头部有多少个 32bit（4 字节）
- 6 位标志位
  - URG：紧急指针是否有效
  - ACK：确认号是否有效
  - PSH：提示接收端程序应该立即从 TCP 接收缓冲区中读数据
  - RST：要求对方重新建立连接
  - SYN：请求建立一个连接
  - FIN：通知对方本段连接将关闭
- 16 位窗口大小：告知对方本段的 TCP 接收缓冲区还能容纳多少字节的数据
- 16 位校验和（checksum）：由发送端填充，接收端对 TCP 报文段执行 CRC 算法检验报文段是否损坏
- 16 位紧急指针：偏移量，和序号字段的值相加表示最后一个紧急数据的下一个字节序号

#### 头部选项

- kind：选项类型
  - 0 结束选项
  - 1 空操作
  - 2 最大报文段长度选项
  - 3 窗口扩大因子选项
  - 4 选择性确认：表示是否支持 SACK 技术
    - TCP 通信时若某个 TCP 报文段丢失，TCP 会重新发送最后被确认的 TCP 报文段后续所有报文段，这样原先已经正确传输的 TCP 报文段也可能重复发送，降低了 TCP 性能
    - SACK 技术可以使 TCP 模块值得重新发送丢失的 TCP 报文段，不用发送所有未被确认的 TCP 报文段
  - 5 SACK 实际工作选项
    - 告诉发送方本段已经收到并缓存的不连续的数据块，从而让发送端可以据此检查并重发丢失的数据块
  - 8 时间戳选项
    - 计算通信双方之间的回路事件
- length：选项长度
- info：选项信息

### TCP 连接的建立和关闭

[三次握手，四次挥手](https://baijiahao.baidu.com/s?id=1654225744653405133&wfr=spider&for=pc)

### TCP 状态转移

- 服务端
  - 服务器通过 lsten 系统调用进入 LSTEN 状态，被动等待客户端连接
  - 服务器一旦监听到某个连接请求，就把该连接放入内核等待队列中，并向客户端发送带 SYN 标志的确认段报文，此时状态变更为 SYN_RCVD
  - 若服务器成功接收到客户端发送回来的确认报文段，状态转移到 ESTABLISHED，此时状态是连接双方都能够进行双向数据传输的状态
  - 当客户端主动关闭连接时（通过 close 或 shutdown 系统调用向服务器发送结束报文段），服务器通过返回确认报文段使连接进入 CLOSE_WAIT，表示等待服务器程序关闭连接
  - 服务器检测到客户端关闭连接后也会立即向客户端发送一个结束报文段来关闭连接，进入 LSAT_ACK，以等待客户端对结束报文段的最后一次确认，一旦确认完成就彻底关闭连接

- 客户端
  - 客户端通过 connect 系统调用主动与服务器建立连接，发送一个同步报文段，进入 SYN_SENT
    - 如果 connect 连接的目标端口不存在或端口处于 TIME_WAIT，则服务器向可打护短发送一个复位报文段，connect 调用失败
    - 若目标端口存在但 connect 在超时时间内未收到服务器的确认报文段，则 connect 调用失败
    - connect 调用失败将使连接立即返回初始的 CLOSED
  - 客户端成功收到服务器的同步报文段和确认后，connect 调用成功返回，进入 ESTABLISHED
  - 当客户端主动执行关闭时，将向服务器发送一个结束报文段，进入 FIN_WAIT_1，若此时客户端收到服务器专门用于确认目的的确认报文段，进入 FIN_WAIT_2
  - 若处于 FIN_WAIT_2，服务器处于 CLOSE_WAIT, 此时如果服务器关闭连接（发送结束报文段），客户端将给予确认并进入 TIME_WAIT
  - 处于 FIN_WAIT_2 时要等待服务器发送结束报文段才能进入 TIME_WAIT，否则一直停留在这个状态
  - 若客户端直接接收到结束报文段而不是先收到确认报文段，直接从 FIN_WAIT_1 进入 TIME_WAIT

### TIME_WAIT
