## 哨兵

哨兵其实是一个运行在特殊模式下的 Redis 进程，主要负责监控、选主和通知

哨兵进程在运行时周期性的给所有主从库发送 PING 检测是否还在运行，无响应的标记为”下线”，若主库下线则开始切换主从。主从切换完成后把新主库的连接信息发给其他从库，从库执行`replicaof`，和新主库建立连接，进行数据复制。哨兵吧新主库的连接信息通知客户端将请求操作发到新主库上

在网络压力较大、阻塞或主库压力较大的情况下哨兵可能出现误判将主库下线，所以哨兵通常采用多实例组成的集群模式进行部署，引入多个哨兵一起判断，降低误判率。哨兵集群判断出主库“主观下线”后，会选出一个“哨兵领导者”，之后整个过程由它来完成主从切换

选择新主库时，哨兵对从库进行打分，根据从库的网络连接状况、优先级、复制进度和 ID 号进行筛选

哨兵在操作主从切换的过程中，读请求可以在从库上正常执行，不会受到影响。但是由于此时主库已经挂了，而且哨兵还没有选出新的主库，所以在这期间写请求会失败，失败持续的时间 = 哨兵切换主从的时间 + 客户端感知到新主库 的时间

如果不想让业务感知到异常，客户端只能把写失败的请求先缓存起来或写入消息队列中间件中，等哨兵切换完主从后，再把这些写请求发给新的主库，但这种场景只适合对写入请求返回值不敏感的业务，而且还需要业务层做适配，另外主从切换时间过长，也会导致客户端或消息队列中间件缓存写请求过多，切换完成之后重放这些请求的时间变长

哨兵检测主库多久没有响应就提升从库为新的主库，这个时间是可以配置的（down-after-milliseconds 参数）。配置的时间越短，哨兵越敏感，哨兵集群认为主库在短时间内连不上就会发起主从切换，这种配置很可能因为网络拥塞但主库正常而发生不必要的切换，当然，当主库真正故障时，因为切换得及时，对业务的影响最小。如果配置的时间比较长，哨兵越保守，这种情况可以减少哨兵误判的概率，但是主库故障发生时，业务写失败的时间也会比较久，缓存写请求数据量越多

### 哨兵集群

哨兵实例之间可以相互发现，要归功于 Redis 提供的 pub/sub 机制，也就是发布 / 订阅机制

哨兵选举
  - 任何一个实例只要自身判断主库“主观下线”后，就会给其他实例发送 is-master-down-by-addr 命令
  - 其他实例会根据自己和主库的连接情况，做出 Y 或 N 的响应，Y 相当于赞成票，N 相当于反对票
