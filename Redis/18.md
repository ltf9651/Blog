## 切片集群

启动多个 Redis 实例组成一个集群，按照一定的规则把收到的数据划分成多粉，每一份用一个实例保存

Redis Cluster 采用哈希槽（hash slot）处理数据和实例之间的映射关系
  - 一个切片集群共有 16384 个哈希槽
  - 根据键值对的 key 按照`CRC16`算法计算一个 16 bit 的值
  - 16bit 值对 16384 取模，每个模仿数代表一个哈希槽
  - N 个实例部署集群，则每个实例上的槽数为 16384/N

客户端和集群实例建立连接后，实例就会把哈希槽的分配信息发给客户端，客户端收到哈希槽信息后会把该信息缓存在本地，当请求键值对时，先计算键所对应的哈希槽，然后给相应的实例发请求

Redis Cluster 重定向：客户端给一个实例发送数据读写操作时，这个实例上并没有相应的数据，客户端要再给一个新实例发送操作命令，响应结果包含新实例的访问地址，客户端更新本地缓存信息

### 切片集群方案

Codis、Redis Cluster

![](https://github.com/ltf9651/Blog/blob/master/Redis/Core/cluster.png)

1. Codis 业界应用得早，更成熟
1. Codis 兼容性更强，业务中大量单实例客户端可以直接升级到切片集群，Redis Cluster 需要修改代码
1. Redis Cluster 对 Redis 新版本适应性更强
1. Codis 更适合数据迁移

## Codis

### 代理中间件

Codis 是一个代理中间件，当客户端向 Codis 发送指令时，Codis 负责将指令转发到后面的 Redis 实例来执行，并将返回结果再转回给客户端。

Codis 提供 DashBoard 面板，后台管理界面友好。

### 分片原理

Codis 将所有的 key 默认划分为 1024 个槽位 (slot)，它首先对客户端传过来的 key 进行 crc32 运算计算哈希值，再将 hash 后的整数值对 1024 这个整数进行取模得到一个余数，这个余数就是对应 key 的槽位。

### 实现同步

Codis 使用 ZooKeeper 实现不同 Codis 实例之间槽位的同步，将槽位关系存储在 zk 中，并且提供了一个 Dashboard 可以用来观察和修改槽位关系，当槽位关系变化时，Codis Proxy 会监听到变化并重新同步槽位关系，从而实现多个 Codis Proxy 之间共享相同的槽位关系配置。

### 自动均衡

Redis 新增实例，手工均衡 slots 太繁琐，所以 Codis 提供了自动均衡功能。自动均衡会在系统比较空闲的时候观察每个 Redis 实例对应的 Slots 数量，如果不平衡，就会自动进行迁移。

### 缺点

1. 不支持事务
1. 单个 key 的 value 不宜过大
1. 由于多了 Proxy，网络开销比单个 Redis 大
1. ZooKeeper 运维成本

## Cluster

### Redis 亲儿子

相对于 Codis 的不同，它是去中心化的，如图所示，该集群有三个 Redis 节点组成，每个节点负责整个集群的一部分数据，每个节点负责的数据多少可能不一样。这三个节点相互连接组成一个对等的集群，它们之间通过一种特殊的二进制协议相互交互集群信息。Cluster 不支持事务。

### 跳转

当客户端向一个错误的节点发出了指令，该节点会发现指令的 key 所在的槽位并不归自己管理，这时它会向客户端发送一个特殊的跳转指令携带目标操作的节点地址，告诉客户端去连这个节点去获取数据。

```sh
GET x
-MOVED 3999 127.0.0.1:6381
//    槽位标号  目标节点地址
```

### 迁移

从源节点获取内容 => 存到目标节点 => 从源节点删除内容

迁移过程是**同步**的，在目标节点执行 restore 指令到原节点删除 key 之间，原节点的主线程会处于阻塞状态，直到 key 被成功删除。

### 容错

Redis Cluster 可以为每个主节点设置若干个从节点，单主节点故障时，集群会自动将其中某个从节点提升为主节点。如果某个主节点没有从节点，那么当它发生故障时，集群将完全处于不可用状态。不过 Redis 也提供了一个参数 cluster-require-full-coverage 可以允许部分节点故障，其它节点还可以继续提供对外访问。

### 确定失联

因为 Redis Cluster 是去中心化的，一个节点认为某个节点失联了并不代表所有的节点都认为它失联了。所以集群还得经过一次协商的过程，只有当大多数节点都认定了某个节点失联了，集群才认为该节点需要进行主从切换来容错。

## 数据倾斜问题

在使用 Redis Cluster 或 Codis 时，数据都会先按照 CRC 算法的计算值对 Slot（逻辑槽）取模，同时，所有的 Slot 又会由运维管理员分配到不同的实例上。这样，数据就被保存到相应的实例

问题
  - 在某些情况下，实例上的数据分布不均衡，某个实例上的数据特别多
  - 虽然每个集群实例上的数据量相差不大，但是某个实例上的数据是热点数据，被访问得非常频繁

解决
  - 拆分 bigkey 为小的数据，分散保存在不同实例
  - 迁移 slot
  - 不要使用 Hash Tag 进行数据切片
  - 热点数据多副本，每个副本在 key 中随机前缀，让副本数据分配到不同的实例
