## 主从同步

### 主从数据一致性

主从数据可能会由于网络延迟、从库压力大处理慢等问题出现数据延迟，导致主库在数据修改后，客户端读从库的数据依然出现滞后

解决
  - 尽量保证主从库的网络连接状况良好，避免部署在不同机房，或者网络通信密集的地方
  - 监控复制进度：`INFO replication`，如果从库进度值过大，先禁止该从库提供数据服务，等待赶上进度后再上线

[过期策略](https://github.com/ltf9651/Blog/blob/master/Redis/23.md)

有些命令给数据设置的过期时间在从库上可能会被延后，导致应该过期的数据又在从库上被读取到，在业务应用中使用 EXPIREAT/PEXPIREAT 命令，把数据的过期时间设置为具体的时间点，避免读到过期数据

合理配置
  - protected-mode 设置为 no
  - cluster-node-timeout 数值调大
  - slave-serve-stale-data 设置为 no

slave-serve-stale-data 是在主从复制中从服务器是否可以响应客户端的请求，slave-read-only 是设置从库能否处理写命令

主从库设置的 maxmemory 不同，如果 slave 比 master 小，那么 slave 内存就会优先达到 maxmemroy，然后开始淘汰数据，此时主从库也会产生不一致

如果主从同步的 client-output-buffer-limit 设置过小，并且 master 数据量很大，主从全量同步时可能会导致 buffer 溢出，溢出后主从全量同步就会失败。如果主从集群配置了哨兵，那么哨兵会让 slave 继续向 master 发起全量同步请求，然后 buffer 又溢出同步失败，如此反复，会形成复制风暴，这会浪费 master 大量的 CPU、内存、带宽资源，也会让 master 产生阻塞的风险

### CAP 原理

- C - Consistent ，一致性
- A - Availability ，可用性
- P - Partition tolerance ，分区容忍性

### 同步与最终一致性

Redis 支持主从同步和丛丛同步，从节点会尽力保持与主节点的数据一致性

### 增量同步

Redis 同步的是指令流，主节点会将那些对自己的状态产生修改性影响的指令记录在本地的内存 buffer 中，然后异步将 buffer 中的指令同步到从节点，从节点一边执行同步的指令流来达到和主节点一样的状态，一边向主节点反馈自己同步到哪里了 （偏移量）。

因为内存的 buffer 是有限的，所以 Redis 主库不能将所有的指令都记录在内存 buffer 中。Redis 的复制内存 buffer 是一个定长的环形数组，如果数组内容满了，就会从头开始覆盖前面的内容。

如果因为网络状况不好，从节点在短时间内无法和主节点进行同步，那么当网络状况恢复时，Redis 的主节点中那些没有同步的指令在 buffer 中有可能已经被后续的指令覆盖掉了，从节点将无法直接通过指令流来进行同步，这个时候就需要用到更加复杂的同步机制 —— 快照同步。

### 快照同步

遍历主节点中所有数据，持久化到磁盘中，然后发送给从节点进行同步

快照同步是一个非常耗费资源的操作，它首先需要在主库上进行一次 bgsave 将当前内存的数据全部快照到磁盘文件中，然后再将快照文件的内容全部传送到从节点。从节点将快照文件接受完毕后，立即执行一次全量加载，加载之前先要将当前内存的数据清空。加载完毕后通知主节点继续进行增量同步。

在整个快照同步进行的过程中，主节点的复制 buffer 还在不停的往前移动，如果快照同步的时间过长或者复制 buffer 太小，都会导致同步期间的增量指令在复制 buffer 中被覆盖，这样就会导致快照同步完成后无法进行增量复制，然后会再次发起快照同步，如此极有可能会陷入快照同步的死循环。

**当从节点刚刚加入到集群时，它必须先要进行一次快照同步，同步完成后再继续进行增量同步。**

### 无盘复制

在遍历的同时将数据发送给从节点，省去快照持久化道磁盘的时间，生成的快照直接发给从节点进行同步

主节点在进行快照同步时，会进行很重的文件 IO 操作，特别是对于非 SSD 磁盘存储时，快照会对系统的负载产生较大影响。特别是当系统正在进行 AOF 的 fsync 操作时如果发生快照，fsync 将会被推迟执行，这就会严重影响主节点的服务效率。

所以从 Redis 2.8.18 版开始支持无盘复制。所谓无盘复制是指主服务器直接通过**套接字**将快照内容发送到从节点，生成快照是一个遍历的过程，主节点会一边遍历内存，一边将序列化的内容发送到从节点，从节点还是跟之前一样，先将接收到的内容存储到磁盘文件中，再进行一次性加载。

### Wait 复制

Redis 的复制是异步进行的，wait 指令可以让异步复制变身同步复制，确保系统的强一致性 （不严格）。

```sh
> set key value
OK
> wait 1 0
(integer) 1
```

wait 提供两个参数，第一个参数是从库的数量 N，第二个参数是时间 t，以毫秒为单位。它表示等待 wait 指令之前的所有写操作同步到 N 个从库 （也就是确保 N 个从库的同步没有滞后），最多等待时间 t。如果时间 t=0，表示无限等待直到 N 个从库同步完成达成一致。

假设此时出现了网络分区，wait 指令第二个参数时间 t=0，主从同步无法继续进行，wait 指令会永远阻塞，Redis 服务器将丧失可用性。
